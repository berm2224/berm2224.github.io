\documentclass[]{beamer}
\usetheme{CambridgeUS}
%\usecolortheme{crane}

\usepackage{microtype}

% Use utf-8 encoding for foreign characters
\usepackage[latin1]{inputenc}
\usepackage[french]{babel}
\usepackage{textcomp}

\usepackage{times}

\usepackage{algorithmic}
\usepackage[ruled, vlined, slide]{algorithm2e}

\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}

% Setup for fullpage use
% \usepackage{fullpage}

% Uncomment some of the following if you use the features
%
% Running Headers and footers
%\usepackage{fancyhdr}

% Multipart figures
\usepackage{subfigure}

% More symbols
\usepackage{amsmath}
\usepackage{mathrsfs}
% \usepackage{amssymb}
% \usepackage{latexsym}

% Surround parts of graphics with box
% \usepackage{boxedminipage}

% Package for including code in the document
\usepackage{listings}
\usepackage{fancyvrb}

% If you want to generate a toc for each chapter (use with book)
% \usepackage{minitoc}

% This is now the recommended way for checking for PDFLaTeX:
\usepackage{ifpdf}

%\newif\ifpdf
%\ifx\pdfoutput\undefined
%\pdffalse % we are not running PDFLaTeX
%\else
%\pdfoutput=1 % we are running PDFLaTeX
%\pdftrue
%\fi

\usepackage[font={scriptsize, it}]{caption}
\captionsetup{labelformat=empty,labelsep=none}

\usepackage{graphicx}
\usepackage{stmaryrd}


\newcommand{\external}[2]
{
    \begin{center} 
        \href{#1}{\color{blue}\underline{#2}}
    \end{center}
}


\newcommand{\fullscreenImg}[1]
{
    \begin{center}
        \includegraphics[width=108mm,height=62mm,keepaspectratio]{img/#1}
    \end{center}
}

\newcommand{\img}[2]
{
    \begin{figure}
        \begin{center}
            \includegraphics[scale=#1]{img/#2}
        \end{center}
    \end{figure}
}

\newcommand{\imgCaption}[3]
{
    \begin{figure}
        \begin{center}
            \includegraphics[scale=#1]{img/#2}
            %\caption[Submanifold]{#3}
            \caption{#3}
        \end{center}
    \end{figure}
}

\newcommand{\apriori}
{
    \textit{a priori}
}

\newcommand{\frameuptitle}[1]
{
    \underline{\textbf{#1}}\medskip
}

\newcommand{\Fourier}
{
    \mathscr{F}
}

\newcommand{\FourierInv}
{
    \mathscr{F}^{-1}
}


\setbeamertemplate{footline}
{
    \hbox{%
        \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex,center]{title in head/foot}%
            \usebeamerfont{title in head/foot}Chapitre 2.3 - Estimation du mouvement global
        \end{beamercolorbox}%
        \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex,right]{date in head/foot}%
            \usebeamerfont{date in head/foot}
            \insertframenumber{} / \inserttotalframenumber\hspace*{2ex} 
        \end{beamercolorbox}}%
        \vskip0pt%
    }
    
    \setbeamertemplate{frametitle continuation}[from second]
    

\title{Analyse de la vidéo}
\subtitle {Chapitre 2.3 - Estimation du mouvement global}
%\author{Michaël Bernier}
\date{\today}

\begin{document}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \ifpdf
% \DeclareGraphicsExtensions{.pdf, .jpg, .tif}
% \else
% \DeclareGraphicsExtensions{.eps, .jpg}
% \fi

\begin{frame}
    \titlepage
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Estimation du mouvement global (EMG) - Domaine fréquentiel}

\begin{frame}
    \frametitle{Plan de chapitre}
    \tableofcontents[currentsection]
\end{frame}

\begin{frame}
    \frametitle{Estimation du mouvement global}
    
    L'estimation du mouvement global peut être utilisé pour:
    
\begin{itemize}
    \item Alignement d'images;
    \item Réduction de la vibration de la caméra (\textit{jittering});
    \item Compensation de mouvement;
    \item Mosaïque;
    \item Segmentation vidéo;
    \item ...
\end{itemize}

\end{frame}


\begin{frame}
    \frametitle{Estimation du mouvement global}
    \framesubtitle{Exemple: Mosaïque}
    
    \img{0.6}{Mosa}
    
    
\end{frame}

\subsection{Corrélation de phase (translation)}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	Cette méthode utilise les propriétés de la transformation de Fourier ($\Fourier$) pour calculer le déplacement d'image.\medskip
    
    La comparaison des images dans le domaine de Fourier nous permet d'extrapoler les paramètres de déplacement de l'image.
    
    \imgCaption{0.4}{Phase}{Tiré de \textit{Wikipédia}}


\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	On tente d'obtenir le vecteur de déplacement idéal par \textbf{corrélation}, c'est-à-dire en maximisant le produit\footnote{On dénote cette opération \textit{cross-correlation (cc)}} de deux images alignées:

	\begin{eqnarray}\label{ECC}
	E_{cc}(d_x, d_y) = \sum_{(x,y)} \bigg[I(x,y, t_1) \cdot I(x+d_x,y+d_y,t_2)\bigg]
	\end{eqnarray}\bigskip
	
	Quel est le problème avec cette opération?


\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	Par la constance d'illumination:
	
		\begin{eqnarray}\label{CNST}
	    \begin{array}{ccc}
			 \Fourier[I(x,y, t_1)] & = &  \Fourier[I(x+d_x,y+d_y,t_2)] \\
	          \mathcal{I}(f_x, f_y) & = & \mathcal{I}(f_x, f_y) \cdot \displaystyle  e^{2 \pi i (x+d_x,y+d_y)}
	    \end{array}
		\end{eqnarray}
	
	Où le déplacement spatial est refleté par un décalage de phase dans le domaine fréquentiel.

\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	Par l'opération de \textit{cross-correlation} en entre deux images :
	
		\begin{eqnarray}\label{Cross}
	    \begin{array}{ccc}
			E_{cc} & = & \displaystyle \sum_{(x,y)} \bigg[I(x,y, t_1) \cdot I(-x,-y,t_2) \bigg] \\
			\Fourier [E_{cc}] & = & \displaystyle \Fourier  \bigg[ I(-x,-y, t_1) \cdot I(x,y,t_2) \bigg] \\
			\Fourier [E_{cc}] & = & \mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y,t_2)
	    \end{array}
		\end{eqnarray}
	
	Où $\mathcal{I^{*}}$ est le conjugué complexe de$\mathcal{I}$. Afin d'enlever l'influence d'un changement d'illumination global dans l'image, on normalise la cross-corrélation:
	
			\begin{eqnarray}\label{CrossNorm}
		    \begin{array}{ccc}
				\Fourier [E_{cc}] & = & \displaystyle \frac{\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y,t_2)}{|\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y,t_2)|}
		    \end{array}
			\end{eqnarray}

\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	En combinant Eq.\ref{CrossNorm} et Eq.\ref{CNST}:

			\begin{eqnarray}\label{win}
		    \begin{array}{ccc}
				\Fourier [E_{cc}(d_x, d_y)] & = & \displaystyle \frac{\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y,t_2)}{|\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y,t_2)|}\\
				& & \\
			  & = & \displaystyle \frac{\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y, t_1) \cdot  | e^{2 \pi i (x+d_x,y+d_y)} |}{|\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y, t_1)| \cdot e^{2 \pi i (x+d_x,y+d_y)}} \\ & & \\
		  & = & \displaystyle \frac{\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y, t_1) }{|\mathcal{I^{*}}(x,y, t_1) \cdot \mathcal{I}(x,y, t_1)|} \cdot e^{-2 \pi i (x+d_x,y+d_y)}  \\ & & \\
		   & = & e^{-2 \pi i (x+d_x,y+d_y)}
		    \end{array}
			\end{eqnarray}

\end{frame}


\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	\begin{eqnarray}\label{DIRAC}
    \begin{array}{rcl}
        E_{cc}(d_x, d_y) & = & \delta \left(  x+d_x, y+d_y \right)
    \end{array}
    \end{eqnarray}
    
    \medskip
    
    \begin{columns}
        \column{.5\textwidth}
       	L'expression de l'Eq.(\ref{DIRAC}) est une impulsion Dirac située à l'emplacement $(d_x, d_y)$. Il est alors facile de cerner la solution.
        
        \column{.5\textwidth}
        \img{0.5}{Dirac}

    \end{columns}
    \bigskip
            
    Cette méthode est appelé \textbf{corrélation de phase}.
    
\end{frame}

\begin{frame}
    \frametitle{Décalage par corrélation de phase}
    \framesubtitle{Modèle de translation}
    
    L'Eq.\ref{DIRAC} est possible par les propriétés suivantes:\bigskip
    
    \begin{itemize}
        \item Le déphasage spatial: $\Fourier[I(x+d_x, y+d_y)] = \mathcal{I}(f_x, f_y) \cdot e^{-2i\pi(d_x f_x + d_y f_y)}$
        \medskip 
        \item Le spectre de phase de $\mathcal{I}(f_x, f_y) \cdot \mathcal{I}^{*}(f_x, f_y)$ est nul.
        \medskip 
        \item La constance d'illumination, mais on peut la changer de façon globale
                \medskip 
        \item Décalage rigide et translationnel.
    \end{itemize}
    
\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de translation}

	Avantages de cette méthode:
	
	\begin{itemize}
		\item Rapide;
		\item Résultat très bon.
	\end{itemize}\medskip
	
	Désavantages de la méthode:
	
	\begin{itemize}
		\item Exige des images sans trop de bruits ou de changements d'illumination;
		\item Adapté pour un mouvement global sans trop de mouvements locaux.
		\item Difficile à automatiser, car les mouvements globaux ne sont pas nécessairement qu'une translation.
	\end{itemize}\medskip

\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Algorithme de la corrélation de phase}

\begin{scriptsize}
    
	\begin{algorithm}[H]
        \Entree{\fbox{$I(t)$,$I(t+1)$}}
        \Sortie{\fbox{$d^*_x,d^*_y$}: Déplacement global de l'image}
        \medskip
         
        $\mathcal{I}(t) \leftarrow \Fourier[I(t)], \hspace*{5mm}
        \mathcal{I}(t+1) \leftarrow \Fourier[I(t+1)]$\;
        
        $\mathcal{I}^{*}(t+1) \leftarrow$ Conjugué complexe de $\mathcal{I}(t+1)$\;
        \medskip
        
        \underline{On calcule alors la phase pour tous les pixels:}
        
        $Im(t), Re(t) \leftarrow \mathcal{I}(t)$, \hspace*{5mm}
        $Im(t+1), Re(t+1) \leftarrow \mathcal{I}^*(t+1)$\;
        
        
         
        $\theta(t) \leftarrow atan2 \left(\dfrac{Im(t)}{Re(t)}\right)$, \hspace*{5mm}
        $\theta(t+1) \leftarrow atan2\left(\dfrac{Im(t+1)}{Re(t+1)}\right)$\;
        
        
        $Re \leftarrow \cos(\theta(t)+\theta(t+1))$, \hspace*{5mm}
        $Im \leftarrow \sin(\theta(t)+\theta(t+1))$\;
        
        
        $E_{cc} \leftarrow \FourierInv[Re, Im]$\;
        $d^*_{x}, d^*_{y} \leftarrow$ Emplacement du pixel maximum de $E_{cc}$\;

        \Retour{$d^*_{x}, d^*_{y}$} 
    \end{algorithm}
    
\end{scriptsize}

\end{frame}

\subsection{Corrélation de phase (rotation, mise à échelle) }

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de rotation}

	Le modèle décrit précédemment ne permet que de décrire le mouvement de translation. \medskip
	
	Cependant, dans le cas où les deux frames ne sont réunis que par \textit{pure rotation}:
	
	\begin{eqnarray}\label{ROT}
	I(R(x, y), t_2 ) = I(x, y, t_1 )
	\end{eqnarray}
	
	On peut retrouver une expression nous permettant d'estimer le mouvement global par un changement de base.

\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de rotation}

	En exprimant les images en coordonnées polaires, on peut effectuer une translation dans l'espace polaire:
    
    \begin{columns}
        \column{.5\textwidth}
        	\img{0.5}{Polaire}
        
        \column{.5\textwidth}
            \begin{eqnarray}\label{POL}
            \begin{array}{rcl}
                \bar{I}(r, \theta, t_1) &=& I(x, y, t_1 )\\
                \bar{I}(r, \theta, t_2) &=& I(x, y, t_2 )
            \end{array}
            \end{eqnarray}            
            
            \begin{eqnarray*}\label{label}
            \begin{array}{rcl}
                \textsf{Où } \hspace{2mm}
                r       & = & \sqrt{x^2 + y^2}\\
                \theta  & = & \arctan{\left(\frac{y}{x}\right)}
            \end{array}
            \end{eqnarray*}
        
    \end{columns}
    \medskip

	Et en supposant de petites rotations, on obtient:    
    \begin{eqnarray}\label{POLAIRE}
    \bar{I}(r, \theta + \hat{\theta}, t_2) = \bar{I}(r, \theta, t_1) 
    \end{eqnarray}\bigskip	


\end{frame}


\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Mappage en coordonnée polaire}


\begin{figure}[!t]
    \begin{center}
        \includegraphics[scale=0.32]{img/Lena} \hspace{4mm}
        \includegraphics[scale=0.32]{img/PolarLena} 

    \end{center}
    \label{MRIPETbrain}
\end{figure}

\begin{figure}[!t]
    \begin{center}
        \includegraphics[scale=0.48]{img/PolarMapping1} \hspace{2mm}
        \includegraphics[scale=0.48]{img/PolarMapping2}
    \end{center}
    \label{MRIPETbrain2}
\end{figure}

	
\end{frame}


\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de rotation et de changement d'échelle}

	Toujours en effectuant un changement de coordonnées, cette fois-ci en \textbf{coordonnées log-polaires}, on peut représenter le \textbf{changement d'échelle}.
    \medskip
    
     La différence avec les coordonnées polaires vient de l'espacement entre les cercles concentriques qui varient de façon exponentielle:

	\img{0.5}{Barbe}  											
	
\end{frame}

\begin{frame}
    \frametitle{Décalage par corrélation de phase}
    \framesubtitle{Mappage en coordonnée log-polaire}
    
    \begin{figure}
        \begin{center}
            \includegraphics[scale=0.32]{img/Lena} \hspace{4mm}
            \includegraphics[scale=0.32]{img/PolarLena} 
        \end{center}
    \end{figure}
    
    \begin{figure}
        \begin{center}
            \includegraphics[scale=1.0]{img/LogPolarLena} \hspace{4mm}
        \end{center}
        \caption{Lena en coordonnée log-polaire}
    \end{figure}
    
\end{frame}


\begin{frame}
    \frametitle{Décalage par corrélation de phase}
\framesubtitle{Modèle de rotation et de changement d'échelle}
    
    En exprimant les images en coordonnées log-polaires, on peut effectuer une translation dans l'espace log-polaire:
    
    \begin{columns}
        \column{.5\textwidth}
        \img{0.5}{LogPolaire}
        
        \column{.5\textwidth}
        \begin{eqnarray}\label{LOGPOL1}
        \begin{array}{rcl}
        \bar{I}(\rho, \theta, t_1) &=& I(x, y, t_1 )\\
        \bar{I}(\rho, \theta, t_2) &=& I(x, y, t_2 )
        \end{array}
        \end{eqnarray}            
        
        \begin{eqnarray*}\label{LOGPOL2}
        \begin{array}{rcl}
        \textsf{Où } \hspace{2mm}
        \rho    & = & \log \sqrt{x^2 + y^2}\\
        \theta  & = & \arctan{\left(\frac{y}{x}\right)}
        \end{array}
        \end{eqnarray*}
        
    \end{columns}
    \medskip
    
    Et en supposant une petite rotation et un petit changement d'échelle, on obtient:    
    \begin{eqnarray}\label{LOGPOLAIRE}
    \bar{I}(\rho + \hat{\rho}, \theta + \hat{\theta}, t_2) = \bar{I}(r, \theta, t_1) 
    \end{eqnarray}	
    
    
\end{frame}

\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Translation, Rotation et changement d'échelle}

    Le mapping \textbf{log-polaire} tente d'illustrer le changement d'échelle \textbf{rétinal} (de l'oeil humain).\medskip
    
     Dans le cas où les trois transformations sont présentes, mais que la translation est relativement petite:
    
	\begin{eqnarray}\label{CAC}
	I(e^s \cdot R(x,y), t_2) = I(x, y, t_1)
	\end{eqnarray}
	
	Comme la focale est située sur le point central de l'image, il peut être difficile d'estimer le changement d'échelle réel dans les cas de \textbf{translation élevée}.
	
\end{frame}


\begin{frame}
\frametitle{Décalage par corrélation de phase}
\framesubtitle{Algorithme de la corrélation de phase (log-polaire)}

	Une approche séquentielle consiste à séparer en plusieurs étapes l'estimation des paramètres:\bigskip

\begin{footnotesize}
        
    	\begin{algorithm}[H]
            \Entree{\fbox{$I(t)$,$I(t+1)$}}
            \Sortie{\fbox{$d^*_x,d^*_y, R, s$}: Déplacement global de l'image $d^*$, Rotation $R$ et facteur d'agrandissement $s$}
            \medskip
            
            $d^*_x,d^*_y \leftarrow$ Estimation par corrélation de phase avec $I(t)$ et $I(t+1)$\;
            $I^{*}(t) \leftarrow$ Image $I(t)$ modifiée par $d^*_x,d^*_y$\;
            $I_{log}^{*}(t),I_{log}(t+1) \leftarrow$ Mapping log-polaire des images $I^{*}(t)$ et $I(t+1)$\;
            $R,s \leftarrow$ Estimation par corrélation de phase avec $I_{log}^{*}(t)$ et $I_{log}(t+1)$\;
            \medskip
            
            
            \Retour{$d^*_x,d^*_y, R, s$} 
        \end{algorithm}
        
\end{footnotesize}
\end{frame}




\section{Estimation du mouvement global (EMG) - Domain spatial}

\begin{frame}
    \frametitle{Plan de chapitre}
    \tableofcontents[currentsection]
\end{frame}

\begin{frame}
	\frametitle{Estimation paramétrique du mouvement}
		
	Soit $T((x,y);\textbf{p})$ la transformation du pixel $(x,y)$ par le modèle paramétrique, où $\textbf{p}= (p_1,\dots,p_L)$ est l'ensemble des paramètres du modèle.\bigskip
	
	Dans le cas du modèle affine, par exemple, on aura:
\begin{eqnarray*}
T((x,y);\textbf{p}) = \left( \begin{array}{c}
  x' \\
  y' \\
\end{array}
\right)
= \left( \begin{array}{c}
  x + a_0+a_1x+ a_2y \\
  y + b_0+b_1x+ b_2y  \\
\end{array}
\right)
\end{eqnarray*}
et $\mathbf{p}=(a_0,a_1,a_2,b_0,b_1,b_2)$.
\end{frame}


\begin{frame}
	\frametitle{Estimation paramétrique du mouvement}
	
	
	Pour estimer le mouvement pour une fenêtre $W$, il suffit d'estimer les paramètres $\textbf{p}$ du modèle. \textbf{La fenêtre $W$ sera l'ensemble du frame au complet}.
	
	\img{0.4}{Parametre}
	
\end{frame}

\begin{frame}
	\frametitle{Estimation paramétrique du mouvement}
    
	  Cette estimation est réalisée par la minimisation de la fonction suivante:

\begin{eqnarray}
E(\textbf{p}) = \sum_{(x,y)\in W} \big[I(T((x,y);\textbf{p}), t_1) - I(x,y,t_2)\big]^2 \label{EQ_L_K2}
\end{eqnarray}
    On peut minimiser cette fonction soit par un \textbf{algorithme d'optimisation }(descente de gradient), soit par \textbf{régression linéaire} ou par un \textbf{raffinement itératif}.
    
\end{frame}



\subsection{Estimation paramétrique directe}



\begin{frame}
    \frametitle{Estimation paramétrique directe (raffinement itératif)}
    
    Ayant une valeur courante $\textbf{p}^{(k)}$, l'estimation  de $\Delta \textbf{p}^{(k)}$ revient à minimiser la fonction
    suivante sur $\Delta \textbf{p}^{(k)}$:
    
    \begin{small}
        \begin{eqnarray}
        E(\Delta \mathbf{p}^{(k)}) = \sum_{(x,y)\in W} \big[I(T((x,y);\mathbf{p}^{(k)}+\Delta \mathbf{p}^{(k)}), t_1)
        - I(x,y,t_2)\big]^2 \label{EQ_L_K3}
        \end{eqnarray}
    \end{small}
    
    Après le développement de Taylor à l'ordre 1 de la fonction (\ref{EQ_L_K3}), on obtient l'équation suivante:
    
    \begin{small}
        \begin{eqnarray}
        E(\Delta \mathbf{p}^{(k)}) & \simeq & \sum_{(x,y)\in W} \big[
        I(T((x,y);\mathbf{p}^{(k)}), t_1) +
        \nabla I \frac{\partial T}{\partial \mathbf{p}}
        \Delta \mathbf{p}^{(k)}  \\
        & &  - I(x,y,t_2)\big]^2 \label{EQ_L_K4}
        \end{eqnarray}
    \end{small}
    
\end{frame}

\begin{frame}
    \frametitle{Estimation paramétrique directe (raffinement itératif)}
    
      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.5]{img/cats-magic}
           \end{center}
       \end{figure}
    
    
\end{frame}

%\begin{frame}
%    \frametitle{Estimation paramétrique directe}
%    
%    L'expression du gradient $\nabla I$ est calculée sur la fenêtre transformée par  $\mathbf{p}^{(k)}$:
%    
%    \begin{eqnarray*} \label{GRADIENT}
%    \nabla I = \left(\frac{\partial I(T((x,y);\mathbf{p}^{(k)})}{\partial x} , \frac{\partial I(T((x,y);\mathbf{p}^{(k)})}{\partial y}\right)
%    \end{eqnarray*}
%    
%\end{frame}

%\begin{frame}
%    \frametitle{Estimation paramétrique directe}
%    
%    La minimisation de la fonction (\ref{EQ_L_K4}) revient alors à résoudre l'équation suivante:
%    
%    \begin{eqnarray*}
%    \frac{\partial E(\Delta \mathbf{p}^{(k)})}{\partial \Delta \mathbf{p}^{(k)}} = \textbf{0}
%    \end{eqnarray*}
%    
%    Après une manipulation directe, on obtient:
%    
%    \begin{footnotesize}	
%        \begin{eqnarray} \label{UPDATE_L-K}
%        \Delta \mathbf{p}^{(k)}\!&\simeq&\!\Bigg[
%        \sum_{(x,y)\in W} \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T
%        \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T\Bigg]^{-1} \nonumber \\
%        && \Bigg[ \sum_{(x,y)\in W}  \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T
%        \bigg[ I(T((x,y);\mathbf{p}^{(k)}), t_1)  - I(x,y,t_2)\bigg] \Bigg]
%        \end{eqnarray}
%    \end{footnotesize}
%    
%\end{frame}

\begin{frame}
    \frametitle{Estimation paramétrique directe (raffinement itératif)}
    
    Par manipulation directe, on obtient alors:

    \begin{footnotesize}	
        \begin{eqnarray} \label{UPDATE_L-K}
        \Delta \mathbf{p}^{(k)}\!&\simeq&\! \dfrac{ \displaystyle \sum_{(x,y)\in W} \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]
            \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T}{\displaystyle \sum_{(x,y)\in W}  \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T
            \bigg[ I(T((x,y);\mathbf{p}^{(k)}), t_1)  - I(x,y,t_2)\bigg] }
        \end{eqnarray}
    \end{footnotesize}
       
\end{frame}


\begin{frame}
    \frametitle{Estimation paramétrique directe}
    \frametitle{Algorithme de l'estimation paramétrique directe}
    
\begin{tiny}
    \begin{algorithm}[H]
        \Entree{\fbox{$I(t)$,$I(t+1)$}}
        \Sortie{\fbox{$\mathbf{p}^{(k)}$}: Paramètres du modèle de mouvement global de l'image}
        \medskip
        
        \underline{Recherche exhaustive ou descente du gradient:}\\        
        $p^0 \leftarrow$ Initialisation par recherche exhaustive\;
        \medskip
        
        \underline{Raffinement itératif:}\\        
        \Tq{$\Delta \mathbf{p}^{(k)} < \epsilon$}
        {
            $I\left( T \left( (x,y);\mathbf{p}^{(k)} \right), t \right) \leftarrow$ Image $I(t)$ transformée par les paramètres $\mathbf{p}^{(k)}$\; 
            $\nabla I \leftarrow$ Calculer le gradient de l'image $I\left( T \left( (x,y);\mathbf{p}^{(k)} \right), t \right)$\;
            $\frac{\partial T}{\partial \textbf{p}} \leftarrow$ Calculer la matrice des dérivées partielles du modèle de transformation\;
            $\bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]$ et
            $\Bigg[\bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]
            \bigg[\nabla I \frac{\partial T}{\partial \textbf{p}} \bigg]^T\Bigg]^{-1} \leftarrow$ Calculer les termes de Eq.(\ref{UPDATE_L-K})\;
            $\Delta \mathbf{p}^{(k)} \leftarrow$ Calculer Eq.(\ref{UPDATE_L-K}).\; 
            $\mathbf{p}^{(k+1)} \leftarrow \Delta \mathbf{p}^{(k)} + \mathbf{p}^{(k)}$\; 
            $k \leftarrow k+1$\;
        }
        \Retour{$\mathbf{p}^{(k)}$}     
    \end{algorithm}
\end{tiny}
    
\end{frame}

\subsection{Moindres carrés - estimation indirecte (vecteurs de mouvement)}

\begin{frame}
    \frametitle{Estimation paramétrique indirecte (Translation)}
    
    À la différence de l'estimation paramétrique directe, on utilise les \textbf{vecteurs de mouvements précédemment calculés} afin d'y retrouver un \textbf{mouvement global commun}. \medskip
    
    Supposons un mouvement translationnel et $d^*$ le mouvement translationnel global commun $d^*$. L'expression de l'énergie à minimiser est:
    
    \begin{eqnarray}
    E(\textbf{d}^{*}) = \displaystyle \sum_{(x,y)\in W} \big[\textbf{d}(x,y) - \textbf{d}^*\big]^2 \label{EQ_INDIRECT}
    \end{eqnarray}

\end{frame}

\begin{frame}
    \frametitle{Estimation paramétrique indirecte (Translation)}
    \frametitle{Algorithme de l'estimation paramétrique indirecte (Translation)}
    
    \begin{footnotesize}
        \begin{algorithm}[H]
            \Entree{\fbox{$I(t)$,$I(t+1)$}}
            \Sortie{\fbox{$\mathbf{d}^{*}$}: Paramètres du modèle de mouvement global de l'image}
            \medskip
            
            $\mathbf{d}_x, \mathbf{d}_y \leftarrow$ Estimation du mouvement (bloc fixe, H-S, \dots )\;
            $\mathbf{d}^* \leftarrow$ Minimisation de l'Eq.\ref{EQ_INDIRECT}\;
            
            \Retour{$\mathbf{d}^*$}     
        \end{algorithm}
    \end{footnotesize}\bigskip
    
    Si on a déjà accès aux vecteurs de déplacement, une \textbf{compensation du mouvement} est très simple à appliquer à l'aide de cette méthode.
    
\end{frame}


\begin{frame}
	\frametitle{Estimation paramétrique}
	\frametitle{Amélioration par estimation robuste}
    
    On peut améliorer nos résultats en \textbf{retirant les pixels} qui sont trop différents du mouvement global trouvé ou en \textbf{séparant les images en régions}:
    
    \begin{enumerate}
        \item Prendre tous les pixels des images comme région;
        \item Appliquer la méthode directe ou indirecte pour toute la région;
        \item Évaluer l'erreur pour tous les pixels de la région;
        \item Éliminer les pixels ayant une erreur trop élevée;
        \item Répéter les étapes 2-4 pour les pixels exclus.
    \end{enumerate}
    	
\end{frame}

\section{Estimation du mouvement global (EMG) - Échantillonnage}
\subsection{RANSAC}


\begin{frame}
	\frametitle{EMG - RANSAC}
	Une autre technique utilise des \textbf{points clés} de des images aux temps $t$ et $t+1$ et tente de les associer à l'aide d'une transformation $T$.
	
      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.4]{img/RANSAC_1}
           \end{center}
       \end{figure}    
  
  	Mais comment associer les points?
  	
\end{frame}

\begin{frame}
	\frametitle{EMG - RANSAC}
	
	On observe non seulement le point, mais le voisinage autour du point (fenêtre, ou \textit{patche})
	
\begin{itemize}
\item \textbf{Recherche exhaustive} (long)
\item \textbf{Classification} : On utilise un vecteur descriptif de l'entourage du point, et on compare les vecteurs similaires.
\item \textbf{Recherche voisinage} : On compare avec les $N$ voisins les plus proches.
\end{itemize}
\end{frame}
\begin{frame}
	\frametitle{EMG - RANSAC}
	  On obtient donc une série de \textit{potentiels} matchs (inliers)
	  
      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.4]{img/RANSAC_2}
           \end{center}
       \end{figure}    
       
  ...mais plusieurs matchs seront faux! (outliers)
\end{frame}
\begin{frame}
	\frametitle{EMG - RANSAC}
	\textbf{RANSAC} : RANdom SAmple Consensus \medskip
	
	On choisit un faible échantillonnage (6 inliers) parmi nos matchs:
	 
      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.4]{img/RANSAC_3}
           \end{center}
       \end{figure}    
  
\end{frame}
\begin{frame}
	\frametitle{EMG - RANSAC}
	
	  On estime la transformation $T$ à l'aide des inliers pris au hasard. On calcule la distance de tous les inliers ($E(D)$), et on garde ceux qui sont plus petit qu'un seuil.
	  
      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.3]{img/RANSAC_4}
           \end{center}
       \end{figure}    
  
  	  On recommence récursivement avec 6 autres inliers, et on garde la transformation $T$ minimisant la distance $E(D)$
\end{frame}


\begin{frame}
	\frametitle{EMG - RANSAC}
	
	Itérations de RANSAC:
	
	\begin{itemize}
	\item On sélectionne 6 points matchés (inliers) au hasard ;
	\item On calcule la matrice $T$ par ces 6 points ;
	\item On conserve les inliers valides (distance $<$ seuil)
	\item On sélectionne 6 inliers qui matches au hasard ;
	\item On calcule la matrice $T$ de ces 6 points ;
	\item ...
	\end{itemize}

  
\end{frame}
\begin{frame}
	\frametitle{EMG - RANSAC}

      \begin{figure}
           \begin{center}
               \includegraphics[scale=0.4]{img/RANSAC_5}
           \end{center}
       \end{figure}    
  
\end{frame}



\end{document}




